# Сервис потокового вещания
Серверная часть сервиса для онлайн трансляции медиафайлов, таких как фото, видео и презентации.
Имеет два основных модуля: АПИ для самой работы с медиа на сервере и сервис онлайн вещания, бесконечно работающий в автономном режиме.
Сервис предназначается для использования на ОС Linux и тестировался только на ОС Ubuntu Server 20.04 LTS.
Однако, возможно использование и на ОС Windows 10/11, так как разработка велась именно с них.
Однако, в таком случае способы установки и запуска будут отличаться, например [poppler 29.02.0-0 для Windows](https://github.com/oschwartz10612/poppler-windows/releases)

## Установка необходимых утилит на Ubuntu

Сервис использует несколько сторонних терминальных утилит, необходимых для обработки видеоизображений и презентаций.

**Установка утилиты [ffmpeg](# "Разработка производилась с использованием ffmpeg 7.0-essentials_build-www.gyan.dev, собранной на gcc 13.2.0 с MSYS2")**

```
sudo add-apt-repository ppa:ubuntuhandbook1/ffmpeg7

sudo apt install ffmpeg
```
Источник: [UbuntuHandbook](https://ubuntuhandbook.org/index.php/2024/04/ffmpeg-7-0-ppa-ubuntu/)

**Установка утилиты [pdftoppm](# "Разработка производилась с использованием pdftoppm 24.02.0")**

```
sudo apt-get install poppler-utils
```
Источник: [Laramatic](https://laramatic.com/how-to-install-pdftoppm-on-debian-ubuntu-alpine-arch-kali-centos-fedora-raspbian-and-macos/)

В случае какой-либо ошибке, попробуйте обновить пакеты на устройстве и переустановить утилиту.
Либо же использовать другие инструкции.

## Установка среды выполнения на Ubuntu

Так как сервис разработан полностью на ЯП JavaScript, то для его запуска потребуется установка интерпретатора.
Для большей совместимости будет требоваться конкретная версия интерпретатора и фреймворков, поэтому также будут установлены nvm и npm.

Для скачивания nvm следует установить специальную утилиту **curl**

**Установка утилиты curl**
```
sudo apt install curl
```

**Установка nvm**
```
sudo curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash

sudo source ~/.bashrc
```

Вторая из вышеупомянутых команд необязательна и может не сработать => в таком случае просто перезапустите терминал.

**Установка npm и Nodejs**
```
nvm install 20.11.1

nvm use 20.11.1
```

Для подключения фреймворков, запустите команду ниже изнутри репозитория

**Установка фреймворков**
```
npm install
```

## Настривание среды

Большинство данных для запуска распологаются в файле ```./libs/configs.js``` и могут быть изменены, однако, это может привести к неработоспособности системы.

Пропишите команду ```which ffmpeg``` и сверьте путь до утилиты с тем, что указан в файле настроек.
В случае несоответствия, измените на свой.

Откройте на устройстве порты: [4004](# "Используется для пользовательского АПИ управления трансляцией"), [1935](# "Используется для видеотрансляции по RTMP"), [8000](# "Используется для видеотрансляции по HTTP") для возможности использования сервиса извне.

Настройте время очистки [программно созданных медиафайлов](# "Видео, полученные из презентаций и изображений") в указывании параметра autoclear в api_interface_config в секундах (по умолчанию 24 часа);
а также в [ссылаемых видопоказах](# "Каждый видеофрагмент в базе данных ссылается на определенное видео. Пока у видео есть хотя бы одна связь, оно не удалится. Поэтому время от времени эту связь нужно удалять автоматически"), 
которые указаны в autoclear в streaming_service_config тоже в секундах (по умолчанию 60 секунд).

Инструкция использования пользовательского АПИ прописана в ```./API.md```

Для внутренних запусков скриптов на nodejs требуется вызов самой команды запуска.
В системе, где был бы установлен только npm, nodejs - это было бы ```node```.
Но в системе, имеющей также nvm - в случае ручного запуска лучше указать ```nvm run <version>```.
В ```system_node_command``` оставьте запуск ```node```, но перед каждым запуском проверяйте, что в **nvm** выбрана версия **20.11.1**.

## Запуск на Ubuntu

В скриптах npm есть запуск сервиса командой ```npm start_app```

Либо вы можете вручную запустить файл **start.js** командой ```nvm run 20.11.1 ./start.js``` или ```node ./start.js``` находясь в корне репозитория.

По умолчанию доступ к трансляции по протоколу RTMP осуществляется через ссылку ```rtmp://localhost:1935/live/stream```
